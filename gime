#!/usr/bin/env bash

# Copyright 2021 Miguel Silva
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


### DEFAULT PROGRAM ARGUMENTS ###
KEYWORD=""
DATA=""
LABEL=""
ALL=false
CONTAINS_KEYWORD=false
SEP1="="
CONTAINS_LABEL=false
SEP2="="
SAVE=false
STRING_CASE=""
DELETE=false
DELETE_ALL=false
DB_PATH=/var/gime/data.db

### USAGE & PROGRAM ARGUMENTS PARSING ###
function usage() {
    printf "$1"
cat << EOF
Usage: gime <KEYWORD> [flags] - Display/Store data associated with a keyword and/or with a label.
-h      --help                          Display program usage
-a      --all                           Display all stored data
-ck     --contains-keyword              Display data that contains <KEYWORD>
-cl     --contains-label                Display data that contains <LABEL>
-l      --label         <LABEL>         Set a <LABEL> in saving mode. Filter by <LABEL> in display mode 
-i      --insensitive                   Set case insensitive in display mode
-s      --save          <DATA>          Save <DATA> along with <KEYWORD> and <LABEL> (if exists)
-d      --delete                        Delete <DATA> that matches the <KEYWORD> and <LABEL> (if exists)
-da     --delete-all                    Delete all saved data
EOF
    exit
}

[[ "$#" == "0" ]] && usage
while :; do
    case "$1" in
        -h|--help)
            usage
        ;;
        -a|--all)
            ALL=true; break
        ;;
        -ck|--contains-keyword)
            CONTAINS_KEYWORD=true; SEP1=" like "
        ;;
        -cl|--contains-label)
            CONTAINS_LABEL=true; SEP2=" like "
        ;;
        -s|--save)
            [[ "$2" != "" ]] && SAVE=true; DATA=$(echo "$2"); shift || usage "Wrong usage.\n"
        ;;
        -l|--label)
            [[ "$2" != "" ]] && LABEL=$(echo "$2"); shift || usage "Wrong usage.\n"
        ;;
        -i|--insensitive)
            STRING_CASE="collate nocase"
        ;;
        -d|--delete)
            DELETE=true
        ;;
        -da|--delete-all)
            DELETE_ALL=true; break
        ;;
        "")
            break
        ;;
        ?*)
            KEYWORD="$1"
        ;;
        *)
            usage "Wrong usage.\n"
        ;;
    esac
    shift
done


### MAIN PROGRAM ###
if $CONTAINS_KEYWORD; then
    KEYWORD="%${KEYWORD}%"
fi
if $CONTAINS_LABEL; then
    LABEL="%${LABEL}%"
fi
if $DELETE_ALL; then
    sqlite3 -batch "${DB_PATH}" "delete from saved_data"
elif $DELETE; then
    if [[ "$KEYWORD" != "" && "$LABEL" != "" ]]; then
        sqlite3 -batch "${DB_PATH}" "delete from saved_data where keyword${SEP1}'${KEYWORD}' and label${SEP2}'${LABEL}'"
    elif [[ "$LABEL" != "" ]]; then
        sqlite3 -batch "${DB_PATH}" "delete from saved_data where label${SEP2}'${LABEL}'"
    else
        sqlite3 -batch "${DB_PATH}" "delete from saved_data where keyword${SEP1}'${KEYWORD}'"
    fi
elif $SAVE; then
    sqlite3 -batch "${DB_PATH}" "insert into saved_data values('${KEYWORD}','${LABEL}','${DATA}')"
elif $ALL; then
    sqlite3 -batch "${DB_PATH}" "select * from saved_data"
else
    if [[ "$KEYWORD" != "" && "$LABEL" != "" ]]; then
        sqlite3 -batch "${DB_PATH}" "select data from saved_data where keyword${SEP1}'${KEYWORD}' ${STRING_CASE} and label${SEP2}'${LABEL}' ${STRING_CASE}"
    elif [[ "$LABEL" != "" ]]; then
        sqlite3 -batch "${DB_PATH}" "select data from saved_data where label${SEP2}'${LABEL}' ${STRING_CASE}"
    else
        sqlite3 -batch "${DB_PATH}" "select data from saved_data where keyword${SEP1}'${KEYWORD}' ${STRING_CASE}"
    fi
fi